# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

UIGen is an AI-powered React component generator with live preview. It allows users to describe React components in natural language, which are then generated by Claude AI and displayed in real-time. The application features a virtual file system (no files written to disk), live preview with hot reload, and component persistence for registered users.

## Development Commands

```bash
# Initial setup (install dependencies, generate Prisma client, run migrations)
npm run setup

# Start development server with Turbopack
npm run dev

# Start development server in background mode (logs to logs.txt)
npm run dev:daemon

# Run tests with Vitest
npm test

# Build for production
npm run build

# Start production server
npm start

# Run linter
npm run lint

# Reset database (force reset all migrations)
npm run db:reset

# Generate Prisma client after schema changes
npx prisma generate

# Create and apply new database migration
npx prisma migrate dev
```

## Architecture Overview

### Core System: Virtual File System

The application's central architecture revolves around a **VirtualFileSystem** (`src/lib/file-system.ts`) that maintains an in-memory file tree. This is NOT a real filesystem - it's a virtual representation that exists only in memory and gets serialized to the database for persistence.

Key concepts:
- All files exist in a Map-based tree structure with a root at "/"
- Files are created, edited, and managed entirely in memory
- The VFS serializes to JSON for storage in the database (Project.data field)
- The VFS is reconstructed from JSON on each request to the `/api/chat` endpoint

### AI Generation Flow

1. **Chat API Endpoint** (`src/app/api/chat/route.ts`):
   - Receives user messages and current VFS state
   - Reconstructs VirtualFileSystem from serialized data
   - Uses Vercel AI SDK's `streamText` with Claude (or mock provider if no API key)
   - Provides two tools to the AI:
     - `str_replace_editor`: View, create, and edit files using string replacement
     - `file_manager`: Rename and delete files/directories
   - Saves conversation history and VFS state back to database on completion

2. **AI Tools** (`src/lib/tools/`):
   - `str-replace.ts`: Claude-style text editor (view, create, str_replace, insert commands)
   - `file-manager.ts`: File operations (rename, delete)
   - Both tools operate directly on the VirtualFileSystem instance

3. **Mock Provider** (`src/lib/provider.ts`):
   - When `ANTHROPIC_API_KEY` is not set, uses MockLanguageModel
   - Returns static component examples (Counter, Form, Card)
   - Simulates multi-step agentic workflow for testing without API costs

### Preview System

The live preview is powered by a sophisticated JSX transformation pipeline:

1. **JSX Transformer** (`src/lib/transform/jsx-transformer.ts`):
   - Uses Babel standalone to transpile JSX/TSX to JavaScript
   - Handles TypeScript and React JSX transforms
   - Detects and strips CSS imports (stored separately)
   - Creates import maps for ES modules loaded from CDN (esm.sh)

2. **Preview Frame** (`src/components/preview/PreviewFrame.tsx`):
   - Renders transformed code in an iframe sandbox
   - Constructs HTML with import maps for React dependencies
   - Injects Tailwind CSS via CDN
   - Hot reloads when file system changes

3. **Import Resolution**:
   - React libraries loaded from esm.sh CDN (React 19)
   - Internal imports (using `@/` alias) resolved to data URLs
   - Missing imports automatically create placeholder modules

### Authentication & Persistence

- **JWT-based auth** (`src/lib/auth.ts`): Uses `jose` library, 7-day sessions stored in httpOnly cookies
- **Anonymous mode** (`src/lib/anon-work-tracker.ts`): Tracks anonymous sessions via cookies, allows testing without signup
- **Database** (Prisma + SQLite):
  - `User`: Authentication (email, hashed password with bcrypt)
  - `Project`: Stores conversation history (messages) and VFS state (data) as JSON strings
  - Prisma client generated to `src/generated/prisma/`
- **Middleware** (`src/middleware.ts`): Protects `/api/projects` and `/api/filesystem` routes

### Component Structure

- **Chat Interface** (`src/components/chat/`): Message display, input, markdown rendering
- **Editor** (`src/components/editor/`): Monaco-based code editor for viewing/editing generated files
- **Preview** (`src/components/preview/`): Iframe-based live preview of generated React components
- **Auth** (`src/components/auth/`): Login/signup forms and flows
- **UI Components** (`src/components/ui/`): shadcn/ui components (Radix UI + Tailwind)

### Next.js App Router Structure

- `/` - Main landing page, redirects to anonymous project or shows project list for authenticated users
- `/[projectId]` - Project workspace with chat, editor, and preview panels
- `/api/chat` - Streaming AI chat endpoint (POST)
- Server actions in `src/actions/`:
  - `create-project.ts`: Create new projects
  - `get-project.ts`: Fetch single project with auth checks
  - `get-projects.ts`: List user's projects

## Key Technical Details

### Prisma Schema Location
The Prisma client is generated to a custom location: `src/generated/prisma/`. Always import from `@/lib/prisma` which wraps the generated client.

The database schema is defined in `prisma/schema.prisma`. Reference it anytime you need to understand the structure of data stored in the database.

### AI System Prompt
Located at `src/lib/prompts/generation.tsx`. Key constraints:
- Must create `/App.jsx` as root component with default export
- Use Tailwind CSS for styling (no inline styles)
- Use `@/` import alias for internal files
- Operating on virtual FS root `/`, not real filesystem

### Testing
Tests use Vitest + React Testing Library. Config at `vitest.config.mts`. Tests located alongside components in `__tests__` directories.

### Environment Variables
- `ANTHROPIC_API_KEY`: Optional. If missing, uses mock provider with static responses
- `JWT_SECRET`: JWT signing secret (defaults to "development-secret-key" in dev)

### File System Serialization
The VFS serializes to a flat object map where keys are paths and values are FileNode objects. The Map-based children structure is rebuilt on deserialization. Two serialization formats:
- `serialize()`: Returns `Record<string, FileNode>` for database storage
- `deserialize(data)`: For legacy simple path->content maps
- `deserializeFromNodes(data)`: For full FileNode objects (current format)

## Code Style Guidelines

### Comments
Use comments sparingly. Only comment complex code where the logic is not self-evident.

## Common Patterns

### Adding a new AI tool
1. Create tool builder function in `src/lib/tools/`
2. Define Zod schema for parameters
3. Implement execute function that operates on VirtualFileSystem
4. Register in `/api/chat/route.ts` tools object
5. Document tool capabilities in system prompt if needed

### Database schema changes
1. Modify `prisma/schema.prisma`
2. Run `npx prisma migrate dev --name descriptive_name`
3. Run `npx prisma generate` to update client
4. Restart dev server to pick up changes

### Adding a new component library
1. Update CDN imports in `src/lib/transform/jsx-transformer.ts` import map
2. Add to available libraries in system prompt if users should know about it
